<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signum Romanum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face {
            font-family: Samian;
            src: url(Samian5-2.32/Samian5-2.32.woff)
        }
        
        .position-input:focus {
            outline: none;
            border-color: #f59e0b;
        }

        .font-samian {
            font-family: Samian;
        }

        .prev-image-container {
          position: relative;
          width: 300px;
          height: 200px;
          background: #f3f4f6 url("img/_placeholder.svg") center / 32px no-repeat;
        }
        
        .prev-image-container img {
          width: 100%;
          height: 100%;
          object-fit: contain;
          display: block;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-red-50 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                üèõÔ∏è Signum Romanum
            </h1>
             <br><p class="text-gray-600">
                Signum Romanum richtet sich direkt an Arch√§ologen, die im Arbeitsalltag auf fragmentierte r√∂mische T√∂pferstempel sto√üen und bisher stundenlang Fachb√ºcher durchsuchen mussten, um diese zu identifizieren. Unsere webbasierte App l√∂st dieses Problem: Durch die Eingabe weniger lesbarer Buchstaben und deren Position liefert ein intelligenter Algorithmus in Sekundenschnelle passende Treffer aus einer eigens aufgebauten Stempeldatenbank ‚Äì ger√§teunabh√§ngig, jederzeit und auch bei unvollst√§ndigen Angaben. Entwickelt wurde die L√∂sung von einem Sch√ºlerforschungsteam aus Dornbirn (Vorarlberg) ‚Äì best√§tigt von allen Experten als erste ihrer Art im Alpenraum.
             </p>
        </div>

        <!-- Suchbereich -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
            <i>W√§hle zuerst die Anzahl der Buchstaben und trage bekannte Buchstaben an den entsprechenden Positionen ein, unbekannte Felder bleiben frei oder mit ‚Äû?‚Äú markiert. Die Trefferliste aktualisiert sich automatisch und kann bei Bedarf √ºber ‚ÄûBuchstaben zur√ºcksetzen‚Äú oder ‚ÄûAlle Filter zur√ºcksetzen‚Äú wieder geleert werden. </i>
            <br><br>
            
            <!-- L√§ngenauswahl -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                    Anzahl der Buchstaben im Stempel:
                </label>
                <input type="range" min="2" max="10" value="7" id="lengthSlider" 
                       class="w-full h-2 bg-amber-200 rounded-lg appearance-none cursor-pointer"
                       onchange="updateLength(this.value)">
                <div class="text-center mt-2">
                    <span class="text-2xl font-bold text-amber-600" id="lengthDisplay">7</span>
                    <span class="text-gray-600 ml-2">Buchstaben</span>
                </div>
            </div>

            <!-- Positionseingabe -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                    Bekannte Buchstaben an ihren Positionen:
                </label>
                <div class="flex flex-wrap gap-2 justify-center" id="positionInputs">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
            </div>

            <!-- Reset Buttons -->
            <div class="flex gap-3">
                <button onclick="resetPositions()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                    Buchstaben zur√ºcksetzen
                </button>
                <button onclick="resetAll()" class="px-6 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
                    Alle Filter zur√ºcksetzen
                </button>
            </div>

            <!-- Info -->
            <div class="mt-4 text-sm text-gray-600">
                <span id="resultCount">0 Stempel gefunden</span>
                <span class="text-gray-500 ml-2" id="filterInfo"></span>
            </div>
        </div>

        <!-- Ergebnisse -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="results">
            <!-- Wird dynamisch gef√ºllt -->
        </div>

        <!-- Keine Ergebnisse -->
        <div id="noResults" class="bg-white rounded-xl shadow-lg p-12 text-center hidden">
            <p class="text-gray-500 text-lg">
                Keine Stempel gefunden
            </p>
            <p class="text-gray-400 text-sm mt-2">
                Versuche eine andere Kombination oder √§ndere die Filter
            </p>
        </div>
    </div>

    <!-- Modal f√ºr Bildanzeige -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 hidden" onclick="closeModal()">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-auto" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800" id="modalTitle"></h3>
                        <p class="text-gray-600 mt-1" id="modalText"></p>
                        <p class="text-sm text-gray-500 mt-1" id="modalPlate"></p>
                    </div>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                        ‚úï
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="bg-gray-50 rounded-lg p-8 text-center">
                    <img id="modalImage" class="mx-auto max-h-96" src="img/A1.png" />
                    <div id="modalPlaceholder">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <p class="text-gray-600 mb-2">Stempelbild</p>
                        <p class="text-sm text-gray-500">(Bild derzeit nicht verf&uuml;gbar)</p>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <div class="rounded-lg text-center">
                    <div>
                        <p class="text-gray-600 mb-2" id="modalSource" style="text-decoration: underline;">Quelle</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="stamps.js"></script>
    <script>     
        let currentLength = 7;
        let positions = Array(10).fill("");
        let frameFilter = 'alle';
        let stampImages = {};

        // Initialisierung
        function init() {
            updatePositionInputs();
            filterStamps();
        }

        // L√§nge aktualisieren
        function updateLength(value) {
            currentLength = parseInt(value);
            document.getElementById('lengthDisplay').textContent = currentLength;
            positions = Array(10).fill("");
            updatePositionInputs();
            filterStamps();
        }

        // Positionseingaben erstellen
        function updatePositionInputs() {
            const container = document.getElementById('positionInputs');
            container.innerHTML = '';
            
            for (let i = 0; i < currentLength; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col items-center';
                
                const label = document.createElement('span');
                label.className = 'text-xs text-gray-500 mb-1';
                label.textContent = i + 1;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.maxLength = 1;
                input.id = `position-${i}`;
                input.className = 'position-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg uppercase';
                input.placeholder = '?';
                input.value = positions[i];
                input.oninput = (e) => handlePositionChange(i, e.target.value);
                input.onkeydown = (e) => handleKeyDown(i, e);
                
                wrapper.appendChild(label);
                wrapper.appendChild(input);
                container.appendChild(wrapper);
            }
        }

        // Position √§ndern
        function handlePositionChange(index, value) {
            positions[index] = value.toUpperCase();
            document.getElementById(`position-${index}`).value = value.toUpperCase();
            
            if (value && index < currentLength - 1) {
                const nextInput = document.getElementById(`position-${index + 1}`);
                if (nextInput) nextInput.focus();
            }
            
            filterStamps();
        }

        // get Plate data algorithm       
        // Format: [startId, endId, pageName]
        const rangesPlates = [
          ["POL-#1","POL-#7","Polak 2000, Plate 37 (p. 490)"],   // (1-7) pl.37
          ["POL-A1","POL-A51","Polak 2000, Plate 1 (p. 454)"],  // 1
          ["POL-A52","POL-A101","Polak 2000, Plate 2 (p. 455)"],  // 2
          ["POL-A102","POL-B43","Polak 2000, Plate 3 (p. 456)"],   // 3
          ["POL-B44","POL-C9*","Polak 2000, Plate 4 (p. 457)"],   // 4
          ["POL-C10","POL-C60","Polak 2000, Plate 5 (p. 458)"],   // 5
          ["POL-C61","POL-C111","Polak 2000, Plate 6 (p. 459)"],   // 6
          ["POL-C112","POL-C160","Polak 2000, Plate 7 (p. 460)"],   // 7
          ["POL-C160*","POL-F2","Polak 2000, Plate 8 (p. 461)"],   // 8
          ["POL-F3","POL-F53","Polak 2000, Plate 9 (p. 462)"],   // 9
          ["POL-F54","POL-G36","Polak 2000, Plate 10 (p. 463)"],   // 10
          ["POL-G37","POL-I34","Polak 2000, Plate 11 (p. 464)"],   // 11
          ["POL-I35","POL-L37","Polak 2000, Plate 12 (p. 465)"],   // 12
          ["POL-L38","POL-M50","Polak 2000, Plate 13 (p. 466)"],   // 13
          ["POL-M51","POL-M98","Polak 2000, Plate 14 (p. 467)"],   // 14
          ["POL-M99","POL-N11","Polak 2000, Plate 15 (p. 468)"],   // 15
          ["POL-N12","POL-P46","Polak 2000, Plate 16 (p. 469)"],   // 16
          ["POL-P47","POL-P93","Polak 2000, Plate 17 (p. 470)"],   // 17
          ["POL-P94","POL-P142","Polak 2000, Plate 18 (p. 471)"],   // 18
          ["POL-P143","POL-R32","Polak 2000, Plate 19 (p. 472)"],   // 19
          ["POL-R33","POL-S43","Polak 2000, Plate 20 (p. 473)"],   // 20
          ["POL-S44","POL-S93*","Polak 2000, Plate 21 (p. 474)"],   // 21
          ["POL-S94","POL-S144","Polak 2000, Plate 22 (p. 475)"],   // 22
          ["POL-S145","POL-T6","Polak 2000, Plate 23 (p. 476)"],   // 23
          ["POL-T7","POL-V36","Polak 2000, Plate 24 (p. 477)"],   // 24
          ["POL-V37","POL-V82","Polak 2000, Plate 25 (p. 478)"],   // 25
          ["POL-V83","POL-X38","Polak 2000, Plate 26 (p. 479)"],   // 26
          ["POL-X39","POL-X90","Polak 2000, Plate 27 (p. 480)"],   // 27
          ["POL-X91","POL-Y40","Polak 2000, Plate 28 (p. 481)"],   // 28
          ["POL-Y41","POL-Y92","Polak 2000, Plate 29 (p. 482)"],   // 29
          ["POL-Y93","POL-Y144","Polak 2000, Plate 30 (p. 483)"],   // 30
          ["POL-Y145","POL-Y196","Polak 2000, Plate 31 (p. 484)"],   // 31
          ["POL-Y197","POL-Y247","Polak 2000, Plate 32 (p. 485)"],   // 32
          ["POL-Y248","POL-Y299","Polak 2000, Plate 33 (p. 486)"],   // 33
          ["POL-Y300","POL-Y351","Polak 2000, Plate 34 (p. 487)"],   // 34
          ["POL-Y352","POL-Z27","Polak 2000, Plate 35 (p. 488)"],   // 35
          ["POL-Z28","POL-Z79","Polak 2000, Plate 36 (p. 489)"],   // 36
          ["POL-Z80","POL-Z115","Polak 2000, Plate 37 (p. 490)"]   // 37
        ];
        
        const rangesSrc = [
          ["POL-#1","POL-Z115","<a href='https://repository.ubn.ru.nl/bitstream/handle/2066/198401/198401pub.pdf?sequence=1&isAllowed=y' target='_blank'>Polak, M. (2000). South Gaulish Terra Sigillata with Potters‚Äô Stamps from Vechten.</a>"]
        ];
        
        // --- Normalize IDs: XXX-X1* ‚Üí sortable string ---
        function normalizeId(id) {
          if (!id) return null;
        
          // Match 3 letters - A-Z or # + 1-3 digits + optional *
          const match = id.match(/^([A-Z]{3})-([A-Z#])(\d{1,3})(\*+)?$/i);
          if (!match) return id; // fallback if format doesn't match
        
          const [_, prefix, letter, numStr, stars] = match;
          const num = parseInt(numStr, 10);
          const starCount = stars ? stars.length : 0;
        
          // base number *10 + number of stars
          return `${prefix}-${letter}${String(num * 10 + starCount).padStart(4, "0")}`;
        }
        
        // --- Create a page map from a set of ranges ---
        function createPageMap(ranges) {
          const map = new Map();
        
          stamps.forEach(stamp => {
            const norm = normalizeId(stamp.id);
        
            for (let i = 0; i < ranges.length; i++) {
              const [start, end, pageName] = ranges[i];
              const startNorm = normalizeId(start);
              const endNorm = normalizeId(end);
        
              if (norm >= startNorm && norm <= endNorm) {
                map.set(norm, pageName);
                break;
              }
            }
          });
        
          return map;
        }
        
        // --- Get plate/page name from a map ---
        function getPage(id, pageMap) {
          return pageMap.get(normalizeId(id)) ?? null;
        }

        const pageMapPlates = createPageMap(rangesPlates);
        const pageMapSrc = createPageMap(rangesSrc);

        // Hilfsfkt existiert Datei?
        function fileExists(url, callback) {
          const img = new Image();
          img.onload = () => callback(true);   // file exists
          img.onerror = () => callback(false); // file missing
          img.src = url;
        }
        
        // Tastatur-Navigation
        function handleKeyDown(index, e) {
            if (e.key === 'Backspace' && !positions[index] && index > 0) {
                const prevInput = document.getElementById(`position-${index - 1}`);
                if (prevInput) prevInput.focus();
            }
        }

        // Umrahmungsfilter setzen
        function setFrameFilter(filter) {
            frameFilter = 'alle';
            filterStamps();
        }

        // Positionen zur√ºcksetzen
        function resetPositions() {
            positions = Array(10).fill("");
            updatePositionInputs();
            filterStamps();
        }

        // Alles zur√ºcksetzen
        function resetAll() {
            positions = Array(10).fill("");
            frameFilter = 'alle';
            setFrameFilter('alle');
            updatePositionInputs();
            filterStamps();
        }

        // Stempel filtern
        function filterStamps() {
            let filtered = stamps;
            
            // Nach Buchstaben filtern
            const hasPositions = positions.some(p => p !== "");
            if (hasPositions) {
                filtered = filtered.map(stamp => {
                    const result = positionMatch(stamp.text, positions, currentLength);
                    return { ...stamp, ...result };
                }).filter(s => s.matches);
                
                // Sortieren
                filtered.sort((a, b) => {
                    // Exakte L√§ngen√ºbereinstimmung bevorzugen
                    const aExact = a.text.length === currentLength ? 1 : 0;
                    const bExact = b.text.length === currentLength ? 1 : 0;
                    if (aExact !== bExact) return bExact - aExact;
                
                    // Danach dein bestehendes Ranking
                    if (a.score !== b.score) return b.score - a.score;
                    if (a.containsScore !== b.containsScore) return b.containsScore - a.containsScore;
                
                    return 0;
                });
            }
            
            displayResults(filtered);
        }

        // Position Matching
        function positionMatch(text, positions, length) {
            const hasAnyPosition = positions.some(p => p !== "");
            if (!hasAnyPosition) return { matches: true, score: 0, matchCount: 0, positionMatchCount: 0 };
            
            let positionMatchCount = 0;
            let containsMatchCount = 0;
            let totalPositions = 0;
            
            const enteredChars = [];
            
            for (let i = 0; i < length && i < positions.length; i++) {
                if (positions[i] && positions[i] !== "") {
                    totalPositions++;
                    enteredChars.push({ char: positions[i].toUpperCase(), position: i });
                }
            }
            
            if (totalPositions === 0) return { matches: true, score: 0, matchCount: 0, positionMatchCount: 0 };
            
            for (let entry of enteredChars) {
                if (entry.position < text.length && text[entry.position] === entry.char) {
                    positionMatchCount++;
                    containsMatchCount++;
                } else if (text.includes(entry.char)) {
                    containsMatchCount++;
                }
            }
            
            const shouldShow = containsMatchCount > 0;
            const positionScore = positionMatchCount / totalPositions;
            const containsScore = containsMatchCount / totalPositions;
            
            return {
                matches: shouldShow,
                score: positionScore,
                containsScore: containsScore,
                matchCount: containsMatchCount,
                positionMatchCount: positionMatchCount,
                totalPositions: totalPositions
            };
        }

        // Ergebnisse anzeigen
        function displayResults(filtered) {
            const container = document.getElementById('results');
            const noResults = document.getElementById('noResults');
            const resultCount = document.getElementById('resultCount');
            const filterInfo = document.getElementById('filterInfo');
            
            container.innerHTML = "";
            
            if (filtered.length === 0) {
                container.classList.add('hidden');
                noResults.classList.remove('hidden');
            } else {
                container.classList.remove('hidden');
                noResults.classList.add('hidden');
                
                filtered.forEach(stamp => {
                    const card = createStampCard(stamp);
                    container.appendChild(card);
                });
            }
            
            resultCount.textContent = `${filtered.length} ${filtered.length === 1 ? 'Stempel gefunden' : 'Stempel gefunden'}`;
            
            filterInfo.textContent = "";
        }

        // Stempelkarte erstellen
        function createStampCard(stamp) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden cursor-pointer transform hover:-translate-y-1';
            card.onclick = () => openModal(stamp);
            
            let matchBadge = "";
            if (stamp.totalPositions > 0) {
                let badgeClass = 'bg-gray-200 text-gray-700';
                let badgeText = `${stamp.matchCount}/${stamp.totalPositions} enthalten`;
                
                if (stamp.positionMatchCount === stamp.totalPositions) {
                    badgeClass = 'bg-green-200 text-green-900';
                } else if (stamp.positionMatchCount > 0) {
                    badgeClass = 'bg-blue-200 text-blue-900';
                    badgeText = `${stamp.positionMatchCount} an richtiger Stelle ‚Ä¢ ${badgeText}`;
                }
                
                matchBadge = `<span class="text-xs px-2 py-1 rounded-full font-semibold ${badgeClass}">${badgeText}</span>`;
            }
            
            
            card.innerHTML = `
                <div class="bg-gradient-to-r from-amber-100 to-orange-100 p-4 border-b-2 border-amber-200">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-semibold text-amber-800">Katalog-Nr: ${stamp.id.replace("#","")}</span>
                        <div class="flex items-center gap-2">
                            ${matchBadge}
                            <span class="text-xs bg-amber-200 text-amber-900 px-2 py-1 rounded-full">${getPage(stamp.id, pageMapPlates)}</span>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="flex items-start gap-4">
                        <div class="flex-1">
                            <div class="text-xs text-gray-500 mb-1">Schriftzug:</div>
                            <div class="text-xl font-bold text-gray-800 tracking-wider font-samian break-words">${stamp.text}</div>
                            <div class="flex items-center gap-2 mt-2">
                                <div class="text-xs text-gray-500">L√§nge: ${stamp.text.length}</div>
                            </div>
                        </div>
                        <div class="flex-shrink-0 w-32 h-20 bg-gray-100 rounded-lg border-2 border-gray-200 overflow-hidden flex items-center justify-center prev-image-container">
                            <img src="img/${stamp.id.replace('**','b').replace('*','a')}.png" class="w-full h-full object-contain" onerror="this.style.display='none'" />`;

            return card;
        }

        // Modal √∂ffnen
        function openModal(stamp) {
            document.getElementById('modalTitle').textContent = `Stempel ${stamp.id.replace("#","")}`;
            document.getElementById('modalText').innerHTML = `Schriftzug: <span class="font-samian font-bold text-xl">${stamp.text}</span>`;
            document.getElementById('modalPlate').textContent = `${getPage(stamp.id, pageMapPlates)}`;
            document.getElementById('modalSource').innerHTML = `${getPage(stamp.id, pageMapSrc)}`;
            
            const modalImage = document.getElementById('modalImage');
            const placeholder = document.getElementById('modalPlaceholder');

            
            fileExists(`img/${stamp.id.replace('**','b').replace('*','a')}.png`, exists => {
              if (exists) {
                modalImage.src = `img/${stamp.id.replace('**','b').replace('*','a')}.png`;
                modalImage.classList.remove('hidden');
                placeholder.classList.add('hidden');
              } else {
                placeholder.classList.remove('hidden');
                modalImage.classList.add('hidden');
              }
                
              document.getElementById('imageModal').classList.remove('hidden');
            });
            
        }

        // Modal schlie√üen
        function closeModal() {
            document.getElementById('imageModal').classList.add('hidden');
        }

        // Start
        init();
    </script>
</body>
</html>
